# ğŸ”„ Tema 6: Reducers

## ğŸš€ Â¿QuÃ© es un Reducer en LangGraph?  

Los **reducers** en LangGraph permiten consolidar y procesar datos provenientes de diferentes nodos o caminos.  
Cuando un grafo sigue **flujos paralelos o mÃºltiples bifurcaciones**, los reducers **recogen, combinan o modifican** los resultados, facilitando una salida coherente y organizada.  

ğŸ‘‰ **Piensa en un reducer como un colector de datos** que une los resultados de distintas partes del grafo en un solo punto.  

---

### ğŸ§  Â¿Por quÃ© son Importantes los Reducers?  

- **ConsolidaciÃ³n de Datos:** ReÃºne informaciÃ³n de diferentes nodos y la almacena en el estado.  
- **Flujos Complejos:** Permite manejar y combinar respuestas de mÃºltiples caminos paralelos.  
- **OptimizaciÃ³n:** Evita que se sobrescriban datos, aÃ±adiendo nuevos resultados al estado existente.  

---

## âš™ï¸ Â¿CÃ³mo se Define un Reducer?  

LangGraph proporciona reducers predefinidos como `add_messages`, que facilita la consolidaciÃ³n de listas de mensajes en el estado.  
Esto es especialmente Ãºtil en flujos conversacionales donde el historial de mensajes **se acumula a lo largo del tiempo.**  

---

### ğŸ“‹ Ejemplo PrÃ¡ctico: Reducer con `add_messages`  

A continuaciÃ³n, definiremos un `State` personalizado que incluye un historial de mensajes que se actualizarÃ¡ usando `add_messages`.  

```python
from typing import Annotated
from langgraph.graph import MessagesState
from langchain_core.messages import AnyMessage
from langgraph.graph.message import add_messages

# Define un estado con historial de mensajes usando add_messages
class State(TypedDict):
    messages: Annotated[list[AnyMessage], add_messages]
    added_key_1: str
    added_key_2: str
``` 

---

### ğŸ” ExplicaciÃ³n del Ejemplo:  

- **`Annotated`**: Permite agregar metadatos al campo `messages` que especifica el uso del reducer `add_messages`.  
- **`add_messages`**: Es un reducer que **aÃ±ade nuevos mensajes al historial** sin sobrescribir los existentes.  
- **Estado Personalizado:** AdemÃ¡s del historial, agregamos claves (`added_key_1`, `added_key_2`) que se actualizarÃ¡n con el flujo del grafo.  

---  

## ğŸ› ï¸ Ejemplo Completo con Reducers  

Vamos a modificar el chatbot de departamentos para **almacenar el historial de mensajes** de cada nodo.  
Cada vez que un nodo procese el mensaje del usuario, **se aÃ±adirÃ¡ al historial existente.**  

```python

```  

---

### ğŸ” ExplicaciÃ³n del Nuevo Flujo:  

- **Nodo de Entrada (user_input):** AÃ±ade el primer mensaje al historial.  
- **Router (route_request):** Determina el nodo de destino (soporte, ventas o general).  
- **Nodos de Departamento:** Cada nodo aÃ±ade una respuesta al historial mediante `add_messages`.  

---

## ğŸš€ Invocando el Grafo con Reducers  

Ejecutamos el grafo y observamos cÃ³mo se acumulan los mensajes en el historial.  
[codigo3]  
```python

``` 

---

### ğŸ“Š Resultado Esperado  
[resultado1]  
```python

``` 

El historial de mensajes muestra el recorrido completo, consolidando tanto las entradas del usuario como las respuestas del chatbot.  

---

## âœ¨ CreaciÃ³n de un Reducer Personalizado  

A veces, los reducers predefinidos no cubren todas las necesidades. LangGraph permite **crear reducers personalizados** para manipular el estado de maneras mÃ¡s especÃ­ficas.  

---

### ğŸ“‹ Ejemplo: Reducer Personalizado para Contar Mensajes  

Definiremos un reducer que **cuenta cuÃ¡ntos mensajes se han procesado** y actualiza el estado con el total acumulado.  

[codigo4]  
```python

``` 

---

### ğŸ” ExplicaciÃ³n del Reducer Personalizado:  

- **`count_messages`**: Cada vez que se aÃ±ade un mensaje, incrementa un contador en el estado.  
- **Flexibilidad Total:** Permite definir cualquier lÃ³gica de consolidaciÃ³n segÃºn los requisitos del flujo.  

---

## ğŸš€ Probamos el Reducer Personalizado  

Invocamos el grafo y verificamos cÃ³mo el estado se actualiza con el nÃºmero total de mensajes.  
[codigo5]  

---

### ğŸ“Š Resultado Esperado  
[resultado2]  

El estado reflejarÃ¡ tanto el historial de mensajes como el total acumulado.  

---

## ğŸ§‘â€ğŸ« Â¿QuÃ© Hemos Aprendido?  

- **Reducers:** Consolidadores de datos que permiten manejar mÃºltiples caminos paralelos.  
- **add_messages:** Reducer predefinido que facilita la acumulaciÃ³n de mensajes.  
- **Reducers Personalizados:** Flexibilidad para definir consolidaciones especÃ­ficas y personalizadas.  

---

## ğŸŒ Â¿QuÃ© es lo Siguiente?  

En el prÃ³ximo tema, hablaremos de **Tools (Herramientas)**, explorando cÃ³mo integrar herramientas externas y APIs dentro del grafo para ampliar sus capacidades.  
