# 🔄 Tema 6: Reducers

## 🚀 ¿Qué es un Reducer en LangGraph?  

Los **reducers** en LangGraph permiten consolidar y procesar datos provenientes de diferentes nodos o caminos.  
Cuando un grafo sigue **flujos paralelos o múltiples bifurcaciones**, los reducers **recogen, combinan o modifican** los resultados, facilitando una salida coherente y organizada.  

👉 **Piensa en un reducer como un colector de datos** que une los resultados de distintas partes del grafo en un solo punto.  

---

### 🧠 ¿Por qué son Importantes los Reducers?  

- **Consolidación de Datos:** Reúne información de diferentes nodos y la almacena en el estado.  
- **Flujos Complejos:** Permite manejar y combinar respuestas de múltiples caminos paralelos.  
- **Optimización:** Evita que se sobrescriban datos, añadiendo nuevos resultados al estado existente.  

---

## ⚙️ ¿Cómo se Define un Reducer?  

LangGraph proporciona reducers predefinidos como `add_messages`, que facilita la consolidación de listas de mensajes en el estado.  
Esto es especialmente útil en flujos conversacionales donde el historial de mensajes **se acumula a lo largo del tiempo.**  

---

### 📋 Ejemplo Práctico: Reducer con `add_messages`  

A continuación, definiremos un `State` personalizado que incluye un historial de mensajes que se actualizará usando `add_messages`.  

```python
from typing import Annotated
from langgraph.graph import MessagesState
from langchain_core.messages import AnyMessage
from langgraph.graph.message import add_messages

# Define un estado con historial de mensajes usando add_messages
class State(TypedDict):
    messages: Annotated[list[AnyMessage], add_messages]
    added_key_1: str
    added_key_2: str
``` 

---

### 🔍 Explicación del Ejemplo:  

- **`Annotated`**: Permite agregar metadatos al campo `messages` que especifica el uso del reducer `add_messages`.  
- **`add_messages`**: Es un reducer que **añade nuevos mensajes al historial** sin sobrescribir los existentes.  
- **Estado Personalizado:** Además del historial, agregamos claves (`added_key_1`, `added_key_2`) que se actualizarán con el flujo del grafo.  

---  

## 🛠️ Ejemplo Completo con Reducers  

Vamos a modificar el chatbot de departamentos para **almacenar el historial de mensajes** de cada nodo.  
Cada vez que un nodo procese el mensaje del usuario, **se añadirá al historial existente.**  

```python

```  

---

### 🔍 Explicación del Nuevo Flujo:  

- **Nodo de Entrada (user_input):** Añade el primer mensaje al historial.  
- **Router (route_request):** Determina el nodo de destino (soporte, ventas o general).  
- **Nodos de Departamento:** Cada nodo añade una respuesta al historial mediante `add_messages`.  

---

## 🚀 Invocando el Grafo con Reducers  

Ejecutamos el grafo y observamos cómo se acumulan los mensajes en el historial.  
[codigo3]  
```python

``` 

---

### 📊 Resultado Esperado  
[resultado1]  
```python

``` 

El historial de mensajes muestra el recorrido completo, consolidando tanto las entradas del usuario como las respuestas del chatbot.  

---

## ✨ Creación de un Reducer Personalizado  

A veces, los reducers predefinidos no cubren todas las necesidades. LangGraph permite **crear reducers personalizados** para manipular el estado de maneras más específicas.  

---

### 📋 Ejemplo: Reducer Personalizado para Contar Mensajes  

Definiremos un reducer que **cuenta cuántos mensajes se han procesado** y actualiza el estado con el total acumulado.  

[codigo4]  
```python

``` 

---

### 🔍 Explicación del Reducer Personalizado:  

- **`count_messages`**: Cada vez que se añade un mensaje, incrementa un contador en el estado.  
- **Flexibilidad Total:** Permite definir cualquier lógica de consolidación según los requisitos del flujo.  

---

## 🚀 Probamos el Reducer Personalizado  

Invocamos el grafo y verificamos cómo el estado se actualiza con el número total de mensajes.  
[codigo5]  

---

### 📊 Resultado Esperado  
[resultado2]  

El estado reflejará tanto el historial de mensajes como el total acumulado.  

---

## 🧑‍🏫 ¿Qué Hemos Aprendido?  

- **Reducers:** Consolidadores de datos que permiten manejar múltiples caminos paralelos.  
- **add_messages:** Reducer predefinido que facilita la acumulación de mensajes.  
- **Reducers Personalizados:** Flexibilidad para definir consolidaciones específicas y personalizadas.  

---

## 🌐 ¿Qué es lo Siguiente?  

En el próximo tema, hablaremos de **Tools (Herramientas)**, explorando cómo integrar herramientas externas y APIs dentro del grafo para ampliar sus capacidades.  
